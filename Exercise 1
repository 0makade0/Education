using System;

namespace Languages
{
    class Program
    {
        static void Main(string[] args)
        {
            int matrixSize;
            int elementsCount; //Количество элементов матрицы
            bool verification = false; //истинность проверки на магический квадрат
            //ВВод данных
            while (true)
            {
                Console.WriteLine("Вв-те размерность матрицы: ");
                try
                {
                    matrixSize = Convert.ToInt32(Console.ReadLine());
                    if(matrixSize<3)
                    {
                        throw new FormatException("Введён размер матрицы меньше трёх. Повторите попытку."); 
                    }
                    elementsCount = matrixSize * matrixSize;
                    break;
                }
                catch(FormatException ex)
                {
                    Console.WriteLine($"{ex.Message} Размерность матрицы должна быть больше 2");
                }
            }
            m1:
            while (verification == false)
            {
            int flag = 0;
                
                int SumFirstLine = 0; //Сумма элементов первой строки
                int SumOtherLine = 0; //Сумма элементов других строк
                int count = 0; //счётчик для разбиения массива на матрицу
                
                int countMagic = 0;
                var rand = new Random();
                int[] MassNumber;
                int[,] Matrix;
                MassNumber = new int[elementsCount];
                //Создание и заполнение массива 
                for (int i = 0; i < MassNumber.Length; i++)
                {
                    MassNumber[i] = rand.Next(1, elementsCount + 1);
                    for (int j = 0; j < i; j++)
                    {
                        if (MassNumber[i] == MassNumber[j])
                        {
                            flag = 1;
                            break;
                        }
                    }
                    if (flag == 1)
                    {
                        i--;
                        flag = 0;
                    }
                }

                Matrix = new int[matrixSize, matrixSize];
                //Разбиение одномерного массива на матрицу
                for (int i = 0; i < matrixSize; i++)
                {
                    for (int j = 0; j < matrixSize; j++)
                    {
                        Matrix[i, j] = MassNumber[count];
                        count++;
                    }
                }
                //Сложение элементов первой строки
                for (int i = 0; i < matrixSize; i++)
                {
                    SumFirstLine += MassNumber[i];
                }
                //Проверка на магию по строкам
                for (int i = 0; i < matrixSize; i++)
                {
                    for (int j = 0; j < matrixSize; j++)
                    {
                        SumOtherLine += Matrix[i, j];
                    }
                    if (SumOtherLine == SumFirstLine)
                    {
                        SumOtherLine = 0;
                    }
                    else
                    {
                        SumOtherLine = 0;
                        flag = 1;
                    }
                }
                //Проверка на магию по столбцам
                for (int j = 0; j < matrixSize; j++)
                {
                    for (int i = 0; i < matrixSize; i++)
                    {
                        SumOtherLine += Matrix[i, j];
                    }
                    if (SumOtherLine == SumFirstLine)
                    {
                        SumOtherLine = 0;
                    }
                    else
                    {
                        SumOtherLine = 0;
                        flag = 1;
                    }
                }
                //Проверка на магию по диагоналям
                for (int j = 0; j < matrixSize; j++)
                {
                    SumOtherLine += Matrix[j, j];
                }
                if (SumOtherLine == SumFirstLine)
                {
                    SumOtherLine = 0;
                }
                else
                {
                    SumOtherLine = 0;
                    flag = 1;
                }
                for (int i = 0; i < matrixSize; i++)
                {
                    for (int j = 0; j < matrixSize; j++)
                    {
                        if (i + j == matrixSize - 1)
                            SumOtherLine += Matrix[i, j];
                    }
                }
                if (SumOtherLine == SumFirstLine)
                {
                    SumOtherLine = 0;
                }
                else
                {
                    SumOtherLine = 0;
                    flag = 1;
                }              
                    //Вывод матрицы
                for (int i = 0; i < matrixSize; i++)
                {
                    for (int j = 0; j < matrixSize; j++)
                    {
                        Console.Write($"{Matrix[i, j]} ");
                    }
                    Console.WriteLine();
                }
                //Вывод проверки матрицы на магический квадрат
                if (flag == 0)
                {
                    Console.WriteLine("Матрица является магическим квадратом");
                    verification = true;
                    Console.WriteLine(countMagic);
                }
                else
                {
                    Console.WriteLine("Матрица не является магическим квадратом");
                    countMagic++;
                }
            }
            Console.WriteLine("Хотите повторить? 1-да; любая другая кнопка - нет");
            int c = Convert.ToInt32(Console.ReadLine());
            if (c == 1)
            {
                Console.Clear();
                goto m1;
            }
            return;
        }
    }
}
